# GitHub Actions CI Pipeline for Order Fulfillment System
# Triggers on: push to main, pull requests, and manual workflow dispatch
# Jobs: Build, Test, Code Quality, Docker Build

name: CI Pipeline

on:
  # Trigger on pushes to main branch
  push:
    branches: [ main ]
  
  # Trigger on pull requests targeting main
  pull_request:
    branches: [ main ]
  
  # Allow manual trigger from Actions tab
  workflow_dispatch:

# Environment variables accessible to all jobs
env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  # =============================================================================
  # BUILD & TEST JOB
  # =============================================================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    # Service containers for integration tests
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: orderfulfillment
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      kafka:
        image: confluentinc/cp-kafka:7.5.0
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
        ports:
          - 9092:9092
    
    steps:
      # Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Setup Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'
      
      # Verify Maven installation
      - name: Verify Maven version
        run: mvn --version
      
      # Compile the application
      - name: Compile
        run: mvn clean compile -B
      
      # Run unit tests
      - name: Run Unit Tests
        run: mvn test -B
      
      # Run integration tests (with Testcontainers if any)
      - name: Run Integration Tests
        run: mvn verify -B
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/orderfulfillment
          SPRING_DATASOURCE_USERNAME: postgres
          SPRING_DATASOURCE_PASSWORD: postgres
          SPRING_KAFKA_BOOTSTRAP_SERVERS: localhost:9092
      
      # Package the application
      - name: Package
        run: mvn package -DskipTests -B
      
      # Upload JAR artifact for other jobs
      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
          retention-days: 7
      
      # Upload test results
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: target/surefire-reports/
          retention-days: 7
      
      # Publish test report
      - name: Publish Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Maven Tests
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

  # =============================================================================
  # CODE QUALITY JOB
  # =============================================================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'
      
      # Run SpotBugs (static analysis for bug detection)
      - name: Run SpotBugs
        run: mvn spotbugs:check -B
        continue-on-error: true
      
      # Run Checkstyle (code style enforcement)
      - name: Run Checkstyle
        run: mvn checkstyle:check -B
        continue-on-error: true
      
      # Upload SpotBugs report
      - name: Upload SpotBugs Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-report
          path: target/spotbugsXml.xml
          retention-days: 7
      
      # Upload Checkstyle report
      - name: Upload Checkstyle Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: target/checkstyle-result.xml
          retention-days: 7

  # =============================================================================
  # DOCKER BUILD JOB
  # =============================================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Set up Docker Buildx for multi-platform builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Build Docker image (without pushing)
      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: order-fulfillment-system:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # Run Docker image security scan (Trivy)
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: order-fulfillment-system:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true
      
      # Upload Trivy results to GitHub Security tab
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # =============================================================================
  # SUMMARY JOB
  # =============================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, docker-build]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "Build and Test: ${{ needs.build-and-test.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Docker Build: ${{ needs.docker-build.result }}"
          
          if [[ "${{ needs.build-and-test.result }}" == "failure" ]]; then
            echo "❌ Build and tests failed"
            exit 1
          fi
          
          if [[ "${{ needs.docker-build.result }}" == "failure" ]]; then
            echo "❌ Docker build failed"
            exit 1
          fi
          
          echo "✅ CI Pipeline completed successfully"

# =============================================================================
# WORKFLOW NOTES
# =============================================================================
# This CI pipeline runs on every push to main and every pull request.
# 
# Jobs:
# 1. build-and-test: Compile, test (unit + integration), package
# 2. code-quality: Run SpotBugs and Checkstyle
# 3. docker-build: Build Docker image and scan for vulnerabilities
# 4. ci-summary: Aggregate results and provide summary
#
# Artifacts:
# - application-jar: Packaged JAR file
# - test-results: JUnit test reports
# - spotbugs-report: Static analysis report
# - checkstyle-report: Code style report
#
# Secrets Required: None (public repo)
#
# Future Enhancements:
# - Add code coverage reporting (JaCoCo)
# - Deploy to staging environment on main push
# - Publish Docker image to registry (DockerHub, GHCR)
# - Add performance testing
# - Add OWASP dependency check
# =============================================================================
